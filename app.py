from tkinter import *
from PIL import ImageTk
import os
from random import choices
import time
from blackjack import *
import playsingle
import runwild

class Application():
    
    def __init__(self):
        self.x = 500
        self.y = 470
        self.money = 1000
        self.deck = [32, 32, 32, 32, 32, 32, 32, 32, 32, 128]
    
    def display_menu(self):
        self.window = Tk()       
        self.window.resizable(False, False)
        self.window.title("BJ")
        self.window.geometry('325x145')
        self.window.iconbitmap(os.path.join(os.path.dirname(os.path.realpath(__file__)), "cards", "icon.ico"))
        lbl = Label(self.window, text="This is a free open-source software.\nSources can be found at:\n https://github.com/ThibaultDieudonne/BlackJackExploit")
        lbl.grid(column=0, row=0, pady = 5, padx = 5)
        btnPlay = Button(self.window, text="Play Game", command=self.btn_playMode)
        btnPlay.grid(column=0, row=1, pady = 5, padx = 5)
        btnTrack = Button(self.window, text="Track Game", command=self.btn_trackerMode)
        btnTrack.grid(column=0, row=2, pady = 5, padx = 5)
        self.window.mainloop()
        
    def btn_playMode(self):
        # label reference memory
        self.plabels = []
        self.dlabels = []
        
        # UI inits
        self.window.destroy()
        self.window = Tk()
        self.window.resizable(False, False)
        self.window.title("Black Jack - Play Mode")
        self.window.geometry('{}x{}'.format(self.x, self.y))
        self.window.configure(bg="green")
        self.window.iconbitmap(os.path.join(os.path.dirname(os.path.realpath(__file__)), "cards", "icon.ico"))
        btnMenu = Button(self.window, text="Return to Menu", command=self.return_to_menu, background = "#458b00")
        btnMenu.pack()
        btnMenu.place(x=self.x-97, y=self.y-30)
        btnDeck = Button(self.window, text="Reset Deck", command=self.reset_deck, background = "#458b00")
        btnDeck.pack()
        btnDeck.place(x=self.x-170, y=self.y-30)
        btnRun = Button(self.window, text="Run simulation", command=self.simulation, background = "#458b00")
        btnRun.pack()
        btnRun.place(x=self.x-265, y=self.y-30)
        # dealer cards frame
        self.dframe = Frame(self.window, background = "green")
        self.dframe.grid(row=0, columnspan=1000, sticky = 'w')
        # middle info labels frame
        self.iframe = Frame(self.window, height = 80, background = "green")
        self.iframe.grid(row=1, sticky = 'w', columnspan=1000)
        self.iframe.rowconfigure(0, minsize = 50)
        self.lblg = Label(self.iframe, text="Bet:", background = "green")
        self.lblg.grid(column=0, row=0, pady = 5, padx = 15)
        self.txtbox = Entry(self.iframe, width=7, background = "#458b00")
        self.txtbox.insert(0, '20')
        self.txtbox.grid(column=1, row=0, pady = 5, padx = 5)
        self.btnPlay = Button(self.iframe, text="Deal", command=self.deal, background = "#458b00")
        self.btnPlay.grid(column=2, row=0, pady = 5, padx = 5)
        # player cards frame
        self.pframe = Frame(self.window, background = "green")
        self.pframe.grid(row=2, columnspan=1000, sticky = 'w')
        # bottom info labels frame
        self.bframe = Frame(self.window, background = "green")
        self.bframe.grid(row=3, sticky = 'w', columnspan=1000)
        self.lbli = Label(self.bframe, text="${}".format(self.money), background = "green")
        self.lbli.grid(column=0, row=0, pady = 5, padx = 5)
        self.lbli2 = Label(self.bframe, text="Bet: $0", background = "green")
        self.lbli2.grid(column=1, row=0, pady = 5, padx = 5)
        self.lbli3 = Label(self.bframe, text="Deck composition:", background = "green")
        self.lbli3.grid(column=0, row=1, pady = 5, padx = 5, columnspan=6)
        self.lbli4 = Label(self.bframe, text='    '.join(['{}: {}'.format(['A','2','3','4','5','6','7','8','9','10'][i], self.deck[i])for i in range(10)]), background = "green")
        self.lbli4.grid(column=0, row=2, pady = 5, padx = 5, columnspan=1000)
        self.lbli5 = Label(self.bframe, text="", background = "green")
        self.lbli5.grid(column=0, row=3, pady = 5, padx = 5, columnspan=6)
        self.lbli6 = Label(self.bframe, text='', background = "green")
        self.lbli6.grid(column=0, row=4, pady = 5, padx = 5, columnspan=1000)
        # loading static
        self.imgs = {}
        for name in ['ace','2','3','4','5','6','7','8','9','ten','jack','queen','king']:
            for suit in ['hearts', 'diamonds', 'clubs', 'spades']:
                file_name = '{}_of_{}'.format(name, suit)
                self.imgs[file_name] = ImageTk.PhotoImage(file=os.path.join(os.path.dirname(os.path.realpath(__file__)), "cards", "{}.jpg".format(file_name)))
        self.card_back = ImageTk.PhotoImage(file=os.path.join(os.path.dirname(os.path.realpath(__file__)), "cards", "card_back.jpg"))
        
        self.window.mainloop()
        
    def btn_trackerMode(self):
        
        self.window.destroy()
        self.window = Tk()
        self.window.resizable(False, False)
        self.window.title("Black Jack - Tracker")
        self.window.geometry('{}x{}'.format(self.x, self.y))
        self.window.iconbitmap(os.path.join(os.path.dirname(os.path.realpath(__file__)), "cards", "icon.ico"))
        btnMenu = Button(self.window, text="Return to Menu", command=self.return_to_menu, background = "#458b00")
        btnMenu.pack()
        btnMenu.place(x=self.x-97, y=self.y-30)
        self.window.mainloop()
    
    def deal(self):
        # managing money
        if self.money < 20:
            self.money = 1000
        # managing bet input
        self.bet = self.txtbox.get()
        try:
            self.bet = int(self.bet)
            if self.bet < 0 or self.bet > self.money:
                self.bet = 20
        except TypeError:
            self.bet = 20
        self.money -= self.bet
        # updating UI
        self.refresh_infos()
        self.window.update()
        self.btnPlay.destroy()
        self.window.update()
        self.lblg.config(text = '')
        self.txtbox.destroy()
        # drawing cards
        self.pcards = []
        self.dcards = []
        self.pcards.append(self.draw(0))
        self.dcards.append(self.draw(1))
        self.pcards.append(self.draw(0))
        # displaying face down card
        time.sleep(.8)
        self.dlabels.append(Label(self.dframe, image=self.card_back, background = "green"))
        self.dlabels[-1].grid(column=1, row=0, pady = 5, padx = 5)
        self.window.update()
        # resetting split hand score
        self.split_score = -1
        self.is_split = False
        if score(self.pcards):
            self.play()
        else:
            self.results()
        
    def play(self):
        # finding available self.actions
        self.actions = 0
        if len(self.pcards) == 2 and not self.is_split:
            if self.pcards[0] == self.pcards[1]:
                self.actions = 2
            else:
                self.actions = 1
        # finding strategies
        self.lbli5.config(text = 'Strategies:')
        self.lbli6.config(text = playsingle.run(self.pcards + self.dcards, self.deck, self.bet))
        # updating UI
        self.btnStand = Button(self.window, text="Stand", command=self.results, background = "#458b00")
        self.btnStand.grid(column=1, row=1, pady = 5, padx = 5)
        self.btnHit = Button(self.window, text="Hit", command=self.hit, background = "#458b00")
        self.btnHit.grid(column=2, row=1, pady = 5, padx = 5)
        if self.actions:
            self.btnDouble = Button(self.window, text="Double", command=self.double, background = "#458b00")
            self.btnDouble.grid(column=3, row=1, pady = 5, padx = 5)
        if self.actions == 2:
            self.btnSplit = Button(self.window, text="Split", command=self.split, background = "#458b00")
            self.btnSplit.grid(column=4, row=1, pady = 5, padx = 5)
    
    def hit(self):
        self.kill_action_buttons()
        self.pcards.append(self.draw(0))
        self.eval_hand()
        
    def double(self):
        self.kill_action_buttons()
        self.money -= self.bet
        self.bet *= 2
        self.refresh_infos()
        self.pcards.append(self.draw(0))
        self.results()
    
    def split(self):
        self.money -= self.bet
        self.is_split = True
        self.kill_action_buttons()
        self.plabels[1].destroy()
        del self.pcards[1]
        self.pcards.append(self.draw(0))
        self.eval_hand()
        
    def eval_hand(self):
        s = score(self.pcards)
        if (s > 20 or not s) or (self.is_split and not self.pcards[0]):
            self.results()
        else:
            self.play()
            
    def results(self):
        pscore = score(self.pcards)
        
        if self.is_split and self.split_score == -1:
            if len(self.pcards) > 2:
                time.sleep(.8)
            self.split_score = pscore
            for label in self.plabels[1:]:
                label.destroy()
            while len(self.pcards) != 1:
                del self.pcards[1]
            self.kill_action_buttons()
            self.pcards.append(self.draw(0))
            self.eval_hand()
        else:
            if pscore:
                self.kill_action_buttons()
            # removing face down card
            self.dlabels[1].destroy()
            # playing the dealer
            dscore = score(self.dcards)
            while dscore < 17 and dscore:
                self.dcards.append(self.draw(1))
                dscore = score(self.dcards)
            # finding outcome
            if self.is_split:
                res_txt = 'Split outcome: $'
                outcome = 0
                for sco in [self.split_score, pscore]:
                    if sco == 0:
                        if dscore == 0:
                            outcome += self.bet
                        else:
                            outcome += 2 * self.bet
                    elif sco == dscore and sco < 22:
                        outcome += self.bet
                    elif ((sco > dscore and dscore) or dscore > 21) and sco < 22:
                        outcome += 2 * self.bet
                res_txt += str(outcome)
                self.money += outcome
            else:
                txt_pscore = pscore if pscore else 21
                txt_dscore = dscore if dscore else 21
                res_txt = '{} - {}    '.format(txt_pscore, txt_dscore)
                if pscore == 0:
                    if dscore == 0:
                        res_txt += 'Blackjack against Blackjack (+{})'.format(self.bet)
                        self.money += self.bet
                    else:
                        res_txt += 'Blackjack ! (+{})'.format(2.5 * self.bet)
                        self.money += 2.5 * self.bet
                elif pscore > 21:
                    res_txt += 'Too many ...'
                elif pscore == dscore:
                    res_txt += "It's a push (+{})".format(self.bet)
                    self.money += self.bet
                elif (pscore > dscore and dscore) or dscore > 21:
                    res_txt += "You win ! (+{})".format(2 * self.bet)
                    self.money += 2* self.bet
                else:
                    res_txt += "Dealer wins"
            # updating UI
            self.refresh_infos()
            self.lblr = Label(self.window, text=res_txt, background = "green")
            self.lblr.grid(column=0, row=1, pady = 5, padx = 5, columnspan = 3)
            self.btnNew = Button(self.window, text="Next Hand", command=self.reset, background = "#458b00")
            self.btnNew.grid(column=4, row=1, pady = 5, padx = 5)
        
    def return_to_menu(self):
        self.reset()
        self.window.destroy()
        self.display_menu()
        
    def draw(self, id):
        self.window.update()
        time.sleep(.8)
        if not sum(self.deck):
            self.reset_deck()
        card = choices(population=[i for i in range(10)], weights=self.deck, k=1)[0]
        self.deck[card] -= 1
        suit = choices(population=['hearts', 'diamonds', 'clubs', 'spades'], k=1)[0]
        card_name = ['ace','2','3','4','5','6','7','8','9','ten'][card]
        if card_name == 'ten':
            card_name = choices(population=['ten', 'jack', 'queen', 'king'], k=1)[0]
        if id:
            self.dlabels.append(Label(self.dframe, image=self.imgs['{}_of_{}'.format(card_name, suit)], anchor="w", background = "green"))
            self.dlabels[-1].grid(column=len(self.dlabels)-1, row=0, pady = 5, padx = 5)
        else:
            self.plabels.append(Label(self.pframe, image=self.imgs['{}_of_{}'.format(card_name, suit)], anchor="w", background = "green"))
            self.plabels[-1].grid(column=len(self.plabels)-1, row=0, pady = 5, padx = 5)
        self.refresh_infos()
        self.window.update()
        return card
    
    def refresh_infos(self):
        self.lbli3.config(text = 'Deck composition:')
        self.lbli.config(text='${}'.format(self.money))
        self.lbli2.config(text="Bet: ${}".format(self.bet))
        self.lbli4.config(text='    '.join(['{}: {}'.format(['A','2','3','4','5','6','7','8','9','10'][i], self.deck[i])for i in range(10)]))
        self.window.update()
        
    def kill_action_buttons(self):
        self.btnStand.destroy()
        self.btnHit.destroy()
        if self.actions:
            self.btnDouble.destroy()
        if self.actions == 2:
            self.btnSplit.destroy()
        self.lblg.config(text='')
        self.window.update()
        return None
    
    def reset(self):
        for l in self.plabels:
            l.destroy()
        for l in self.dlabels:
            l.destroy()
        self.plabels = []
        self.dlabels = []
        try:
            self.lblr.destroy()
            self.btnNew.destroy()
        except:
            pass
        self.lbli5.config(text = '')
        self.lbli6.config(text = '')
        self.lblg = Label(self.iframe, text="Bet:", background = "green")
        self.lblg.grid(column=0, row=0, pady = 5, padx = 5)
        self.txtbox = Entry(self.iframe, width=7, background = "#458b00")
        self.txtbox.insert(0, '20')
        self.txtbox.grid(column=1, row=0, pady = 5, padx = 5)
        self.btnPlay = Button(self.iframe, text="Deal", command=self.deal, background = "#458b00")
        self.btnPlay.grid(column=2, row=0, pady = 5, padx = 5)
    
    def reset_deck(self):
        self.deck = [32, 32, 32, 32, 32, 32, 32, 32, 32, 128]
        self.refresh_infos()
    
    def simulation(self):
        ev = runwild.run(self.deck)
        self.lbli3.config(text = 'Deck composition (Global EV = {}%):'.format(ev))
        self.window.update()
        
if __name__ == '__main__':
    myapp = Application()
    myapp.display_menu()
